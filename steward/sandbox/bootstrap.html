<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>steward bootstrap</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<script src='js-beautify-master/beautify.js'></script>
<script>
// BEGIN: BOOSTRAP

// all of these things are normally done by the first client that does the tap...


// you may change the name field, if you wish
// you may change the physical address field, if you wish
// please change the latitude and longitude in the location below (needed to calculate solar time, e.g., dawn)

var place_info   = { name        : 'Home'
                   , physical    : ''
                   , location    : [ 39.50000, -98.35000 ]
                   };


// if you have any of these products/services, please fill-in the relevant 'info' fields...

var bootable = { prowl          :
                 { text         : 'If you have a Prowl account, the steward can automatically update you with alerts, etc.'
                 , instructions : 'Generate an API key.'
                 , site         : 'https://prowlapp.com/login.php'
                 , icon         : ''
                 , name         : 'prowler'
                 , actor        : '/device/indicator/text/prowl'
                 , info         :
                   { name       : 'prowler'
                   , apikey     : ''
                   }
                 }
               , netatmo        :
                 { text         : 'If you have a Netatmo weather station, the steward can manage it for you.'
                 , instructions : 'Enter your email and password.'
                 , site         : 'https://my.netatmo.com'
                 , icon         : ''
                 , name         : 'netatmo'
                 , actor        :'/device/gateway/netatmo/cloud'
                 , info         :
                   { email      : ''
                   , passphrase : ''
                   }
                 }
               , nest           :
                 { text         : 'If you have a Nest thermostat, the steward can manage it for you.'
                 , instructions : 'Enter your email address and password.'
                 , site         : 'https://home.nest.com'
                 , icon         : ''
                 , name         : 'nest'
                 , actor        : '/device/gateway/nest/cloud'
                 , info         :
                   { email      : ''
                   , passphrase : ''
                   }
                 }
               , tesla          :
                 { text         : 'If you have a Tesla Model S, the steward can monitor it for you.'
                 , instructions : 'Enter your email address and password.'
                 , site         : 'https://teslamotors.com/mytesla'
                 , icon         : ''
                 , name         : 'tesla'
                 , actor        : '/device/gateway/tesla/cloud'
                 , info         :
                   { email      : ''
                   , passphrase : ''
                   }
                 }
               , xively         :
                 { text         : 'If you have an Xively (nee cosm) account, the steward can automatically upload measurements.'
                 , instructions : 'Create an API key with READ, UPDATE, and CREATE permissions.'
                 , site         : 'https://xively.com/login'
                 , icon         : ''
                 , name         : 'xively'
                 , actor        : '/device/indicator/text/cosm'
                 , info         :
                   { apikey     : ''
                   }
                 }
               };


// END: BOOTSTRAP


var actors = null;
var events = null;
var tasks  = null;

var bootstrap = function(ws) {
  list_actors(ws, '', { depth : 'all' }, function(message) {
    var a, actor, d, emptyP, entry, info, name, prop, z;

    var update_place   = function() { perform_actors(ws, 'place', 'set', place_info); };

    if ((!message.result) && (!message.error)) return false;
    if ((!message.result) || (!message.result.actors)) throw new Error('actor listing failed');

    actors = message.result;
    z = {};
    for (actor in actors) {
      z[actor] = true;

      if ((!actors.hasOwnProperty(actor)) || (actor === 'actors')) continue;

      if (actor === '/place') {
        if (!actors[actor]['place/1']) throw new Error('actor place/1 is not present');
        d = actors[actor]['place/1'];
        if ((!d.info.location) || (d.info.location.length < 2)) { update_place(); break; }
      }

      for (name in bootable) {
        if (!bootable.hasOwnProperty(name)) continue;

        entry = bootable[name];
        if (entry.actor !== actor) continue;

        info = entry.info;
        emptyP = false;
        for (prop in info) if ((info.hasOwnProperty(prop)) && (info[prop] === '')) emptyP = true;
        if (emptyP) continue;

        for (a in actors[actor]) {
          if (!actors[actor].hasOwnProperty(a)) continue;

          d = actors[actor][a];

          emptyP = false;
          for (prop in info) if ((info.hasOwnProperty(prop)) && (d.info[prop] === '')) emptyP = true;
          if (emptyP) break;
        }
       
        if (!a) create_device(ws, name, entry.actor, info);
      }
    }

    for (name in bootable) {
      if (!bootable.hasOwnProperty(name)) continue;

      entry = bootable[name];
      if (!!z[entry.actor]) continue;

      info = entry.info;
      emptyP = false;
      for (prop in info) if ((info.hasOwnProperty(prop)) && (info[prop] === '')) emptyP = true;
      if (!emptyP) create_device(ws, name, entry.actor, info);
    }

    list_event(ws, '', { depth : 'all' }, function(message) {
      if ((!message.result) && (!message.error)) return false;
      if ((!message.result) || (!message.result.events)) throw new Error('event listing failed');

      events = message.result.events;

      list_task(ws, '', { depth : 'all' }, function(message) {
        if ((!message.result) && (!message.error)) return false;
        if ((!message.result) || (!message.result.tasks)) throw new Error('task listing failed');

        tasks = message.result.tasks;

        apprentice0a(ws);
        apprentice0b(ws);
        apprentice0c(ws);
        apprentice0d(ws);

        return true;
      });

      return true;
    });

    return true;
  });
};


var waterActivityUUID    = ':apprentice0:activity:water';
var waterEventUUID       = ':apprentice0:events:water';
var waterSensorUUID      = ':apprentice0:sensors:water';
var waterTaskUUID        = ':apprentice0:tasks:water';
var waterAlarmVisualUUID = ':apprentice0:visual-alarms:water';
var waterAlarmAudioUUID  = ':apprentice0:audio-alarms:water';

var apprentice0a = function(ws) {
return;
  make_tree(ws, waterEventUUID, 'or',   [ { entityUUID    : waterSensorUUID
                                          , entityTypes   : [ '/device/sensor/*/water' ]
                                          , action        : '.condition'
                                          , parameter     : { operator: 'equals', operand1: '.[.water].', operand2: 'present' }
                                          }
                                        ], 'event', events, create_event, 'observe', function(eventID) {
    console.log(waterEventUUID + ' eventID=' + eventID);

    make_tree(ws, waterTaskUUID, 'and', [ { entityUUID    : waterAlarmVisualUUID
                                          , entityTypes   : [ '/device/light/blink*', '/device/light/hue/led' ]
                                          , action        : 'set'
                                          , parameter     : { color: { model: 'rgb', rgb: { r: 255, g: 127, b: 0 } } }
                                          }
                                        , { entityUUID    : waterAlarmAudioUUID
                                          , entityTypes   : [ '/device/media/*/audio' ]
                                          , action        : 'play'
                                          , parameter     : { url: '...' }
                                          }
                                        ], 'task', tasks, create_task, 'perform', function(taskID) {
      console.log(waterTaskUUID + ' taskID=' + taskID);

      create_activity(ws, waterActivityUUID, eventID, taskID, function(message) {
        if ((!message.result) || (!message.result.activity) || (!!message.error)) {
          if (!!message.error) console.log(message.error);
          throw new Error(waterActivityUUID + ' activity creation failed');
        }

        console.log(waterActivityUUID + ' activityID=' + message.result.activity);
      });
    });
  });
};

var apprentice0b = function(ws) {
// activity:
//   event - /device/sensor/arduino/mat's contact: on->off AND media unmuted
//   task  - media group goes mute AND kitchen group goes white
};

var apprentice0c = function(ws) {
// activity:
//   event - /device/sensor/arduino/mat's contact: off->on AND media muted
//   task  - media group goes unmute AND kitchen group goes off
};

var apprentice0d = function(ws) {
// activity:
//   event - CO2>=1000ppm AND fan off
//   task  - fan goes on for 15m
};

var find_all_devices = function(patterns) {
  var actor, device, devices, i, pattern;

  devices = [];

  for (i = 0; i < patterns.length; i++) {
    pattern = patterns[i];
    for (actor in actors) {
      if ((!actors.hasOwnProperty(actor)) || (!actor.match(pattern))) continue;

      for (device in actors[actor]) if (actors[actor].hasOwnProperty(device)) devices.push(device);
    }
  }

  return devices;
};

var make_tree = function(ws, treeUUID, operand, entities, treeType, trees, action, create, callback) {
  var devices, devs, groups, i, id, j, members, entity;

  var cb1 = function() {
    if (members.length < devices.length) return true;

    create_group(ws, treeUUID, treeType, operand, members, function(message) {
      if ((!message.result) || (!message.result.group) || (!!message.error)) {
        if (!!message.error) console.log(message.error);
        throw new Error(treeUUID + ' group creation failed');
      }

      callback('group/' + message.result.group);

      return true;
    });

    return true;
  };

  var cb2 = function(uuid) {
    return function(message) {
      if ((!message.result) || (!message.result[treeType]) || (!!message.error)) {
        if (!!message.error) console.log(message.error);
        throw new Error(uuid + ' creation failed');
      }
      members.push(treeType + '/' + message.result[treeType]);

      return cb1();
    };
  };

  for (id in groups) if ((groups.hasOwnProperty(id)) && (groups[id].uuid === treeUUID)) return callback(id);

  devices = [];
  for (i = 0; i < entities.length; i++) {
    entity = entities[i];
    devices.concat(find_all_devices(entity.entityTypes));
  }  

  members = [];
  for (i = 0; i < entities.length; i++) {
    entity = entities[i];

    devs = find_all_devices(entity.entityTypes);
    for (j = 0; j < devs.length; j++) {
      create(ws, entity.entityUUID + ':' + j, devs[j], entity.action, entity.parameter, cb2(entity.entityUUID + ':' + j));
    }
  }

  return cb1();
};


var rainbow = [ '#ff0000', '#ff8300', '#fff800', '#0000ff', '#00ff00', '#4b0082', '#ee82ee' ];
var colors  = [ 'red',     'orange',  'yellow',  'blue',    'green',   'indigo',  'violet'  ];

var blinky = function(ws, i) {
  var r, g, b;

  if (i >= rainbow.length) i = 0;
  r = parseInt(rainbow[i].substr(1, 2), 16);
  g = parseInt(rainbow[i].substr(3, 2), 16);
  b = parseInt(rainbow[i].substr(5, 2), 16);

  console.log(colors[i] + ':' + r + ',' + g + ',' + b);
  perform_actors(ws, 'device/lighting/blink1',     'on', { color: { model: 'rgb', rgb: { r: r, g: g, b: b }}});
  perform_actors(ws, 'device/lighting/blinkstick', 'on', { color: { model: 'rgb', rgb: { r: r, g: g, b: b }}});

  setTimeout(function() { blinky(ws, ++i); }, 15 * 1000);
};


var notice = function(tag, meta) {
  var update = { monitor : [{ date : new Date().toISOString()
               , level   : 'notice'
               , tag     : tag
               , meta    : (meta || {}) }]
               };

  document.getElementById('status').innerHTML += '<pre>' + js_beautify(JSON.stringify(update)) + '</pre><br/><br/>';
};


var reqno = 1;
var callbacks = {};

var add_callback = function(cb) {
  callbacks[reqno.toString()] = cb;

  return reqno++;
};

var create_activity = function(ws, name, event, task, cb) {
console.log(JSON.stringify({ path      : '/api/v1/activity/create/' + name
                         , requestID : reqno
                         , name      : name
                         , armed     : true
                         , event     : event
                         , task      : task
                         }));
  ws.send(JSON.stringify({ path      : '/api/v1/activity/create/' + name
                         , requestID : add_callback(cb)
                         , name      : name
                         , armed     : true
                         , event     : event
                         , task      : task
                         }));
};

var create_device = function(ws, name, whatami, info, cb) {
  ws.send(JSON.stringify({ path      : '/api/v1/device/create/' + name
                         , requestID : add_callback(cb)
                         , name      : name
                         , whatami   : whatami
                         , info      : info || {}
                         }));
};

var create_event = function(ws, name, actor, observe, parameter, cb) {
console.log(JSON.stringify({ path      : '/api/v1/event/create/' + name
                         , requestID : reqno
                         , name      : name
                         , actor     : actor
                         , observe   : observe
                         , parameter : parameter || ''
                         }));
  ws.send(JSON.stringify({ path      : '/api/v1/event/create/' + name
                         , requestID : add_callback(cb)
                         , name      : name
                         , actor     : actor
                         , observe   : observe
                         , parameter : parameter || ''
                         }));
};

var create_group = function(ws, name, type, operand, members, cb) {
console.log(JSON.stringify({ path    : '/api/v1/group/create/' + name
                         , requestID : reqno
                         , name      : name
                         , type      : type    || ''
                         , operand   : operand || ''
                         , members   : members || []
                         }));
  ws.send(JSON.stringify({ path      : '/api/v1/group/create/' + name
                         , requestID : add_callback(cb)
                         , name      : name
                         , type      : type    || ''
                         , operand   : operand || ''
                         , members   : members || []
                         }));
};

var create_task = function(ws, name, actor, perform, parameter, cb) {
console.log(JSON.stringify({ path      : '/api/v1/task/create/' + name
                         , requestID : reqno
                         , name      : name
                         , actor     : actor
                         , perform   : perform
                         , parameter : JSON.stringify(parameter) || ''
                         }));
  ws.send(JSON.stringify({ path      : '/api/v1/task/create/' + name
                         , requestID : add_callback(cb)
                         , name      : name
                         , actor     : actor
                         , perform   : perform
                         , parameter : JSON.stringify(parameter) || ''
                         }));
};

var list_activity = function(ws, activityID, options, cb) {
  if ((activityID !== '') && (parseInt(activityID, 10) <= 0)) throw new Error('activityID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/activity/list/' + activityID
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var list_actors = function(ws, prefix, options, cb) {
  ws.send(JSON.stringify({ path      : '/api/v1/actor/list/' + prefix
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var list_device = function(ws, deviceID, options, cb) {
  if ((deviceID !== '') && (parseInt(deviceID, 10) <= 0)) throw new Error('deviceID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/device/list/' + deviceID
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var list_event = function(ws, eventID, options, cb) {
  if ((eventID !== '') && (parseInt(eventID, 10) <= 0)) throw new Error('eventID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/event/list/' + eventID
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var list_group = function(ws, groupID, options, cb) {
  if ((groupID !== '') && (parseInt(groupID, 10) <= 0)) throw new Error('groupID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/group/list/' + groupID
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var list_task = function(ws, taskID, options, cb) {
  if ((taskID !== '') && (parseInt(taskID, 10) <= 0)) throw new Error('taskID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/task/list/' + taskID
                         , requestID : add_callback(cb)
                         , options   : options || {}
                         }));
};

var modify_group = function(ws, groupID, name, type, operand, members, cb) {
console.log(JSON.stringify({ path      : '/api/v1/group/modify/' + groupID
                         , requestID : reqno
                         , name      : name
                         , type      : type    || ''
                         , operand   : operand || ''
                         , members   : members || []
                         }));
  ws.send(JSON.stringify({ path      : '/api/v1/group/modify/' + groupID
                         , requestID : add_callback(cb)
                         , name      : name
                         , type      : type    || ''
                         , operand   : operand || ''
                         , members   : members || []
                         }));
};

var perform_activity = function(ws, activityID, cb) {
  if (parseInt(activityID, 10) <= 0) throw new Error('activityID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/activity/perform/' + activityID
                         , requestID : add_callback(cb)
                         }));
};

var perform_actors = function(ws, prefix, perform, parameter, cb) {
  ws.send(JSON.stringify({ path      : '/api/v1/actor/perform/' + prefix
                         , requestID : add_callback(cb)
                         , perform   : perform
                         , parameter : JSON.stringify(parameter) || ''
                         }));
};

var perform_device = function(ws, deviceID, perform, parameter, cb) {
  if (parseInt(deviceID, 10) <= 0) throw new Error('deviceID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/device/perform/' + deviceID
                         , requestID : add_callback(cb)
                         , perform   : perform
                         , parameter : JSON.stringify(parameter) || ''
                         }));
};

var perform_group = function(ws, groupID, perform, parameter, cb) {
  if (parseInt(groupID, 10) <= 0) throw new Error('groupID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/group/perform/' + groupID
                         , requestID : add_callback(cb)
                         , perform   : perform
                         , parameter : JSON.stringify(parameter) || ''
                         }));
};

var perform_task = function(ws, taskID, cb) {
  if (parseInt(taskID, 10) <= 0) throw new Error('taskID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/task/perform/' + taskID
                         , requestID : add_callback(cb)
                         }));
};

var delete_activity = function(ws, activityID, cb) {
  if (parseInt(activityID, 10) <= 0) throw new Error('activityID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/activity/delete/' + activityID
                         , requestID : add_callback(cb)
                         }));
};

var delete_device = function(ws, deviceID, cb) {
  if (parseInt(deviceID, 10) <= 0) throw new Error('deviceID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/device/delete/' + deviceID
                         , requestID : add_callback(cb)
                         }));
};

var delete_event = function(ws, eventID, cb) {
  if (parseInt(eventID, 10) <= 0) throw new Error('eventID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/event/delete/' + eventID
                         , requestID : add_callback(cb)
                         }));
};

var delete_group = function(ws, groupID, cb) {
  if (parseInt(groupID, 10) <= 0) throw new Error('groupID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/group/delete/' + groupID
                         , requestID : add_callback(cb)
                         }));
};

var delete_task = function(ws, taskID, cb) {
  if (parseInt(taskID, 10) <= 0) throw new Error('taskID must be positive integer');

  ws.send(JSON.stringify({ path      : '/api/v1/task/delete/' + taskID
                         , requestID : add_callback(cb)
                         }));
};


var go = function(steward, i) {
  var opened, ws, ws2;
  var tag = 'connection #' + i + ' to ' + steward.protocol + '//' + steward.hostname + ':' + steward.port + '/manage';

  notice(tag, { state: 'connecting...' });
  opened = 0;
  ws = new WebSocket(steward.protocol + '//' + steward.hostname + ':' + steward.port + '/manage' + steward.search);

  ws.onopen = function(event) {/* jshint unused: false */
    opened = 1;
    notice(tag, { state: 'open' });

    ws2 = new WebSocket(steward.protocol + '//' + steward.hostname + ':' + steward.port + '/console' + steward.search);
    ws2.onopen    = function(event) {/* jshint unused: false */};
    ws2.onmessage = function(event) {
      var data, i, updates;

      data = JSON.parse(event.data);
      if (!data['.updates']) return;
      updates = data['.updates'];

      document.getElementById('status').innerHTML += '<pre>' + updates.length + ' updates</pre><br/><br/>';

      for (i = 0; i < updates.length; i++) {
        document.getElementById('status').innerHTML += '<pre>' + js_beautify(JSON.stringify(updates[i])) + '</pre><br/><br/>';
      }
    };
    ws2.onclose   = function(event) {/* jshint unused: false */ ws.close(); };
    ws2.onerror   = function(event) {/* jshint unused: false */ ws.close(); };

    try { bootstrap(ws); } catch(ex) { notice(tag, { state: 'bootstrap', message: ex.message }); }
  };

  ws.onmessage = function(event) {
    var id, message;

    try {
      message = JSON.parse(event.data);
      id = message.requestID.toString();
      if ((!!callbacks[id]) && ((callbacks[id])(message))) delete(callbacks[id]);
    } catch(ex) {
      notice(tag, { state: 'message', message: ex.message });
    }
    document.getElementById('status').innerHTML += '<pre>' + js_beautify(event.data) + '</pre><br/><br/>';
  };

  ws.onclose = function(event) {
    notice(tag, { state: (opened ? 'closed' : 'error'), code : event.code, message : event.reason });
  };

  ws.onerror = function(event) {
    notice(tag, { state: 'error', event : event });
    try { ws.close (); } catch (ex) {}
  };
};

var main = function() {
  var steward = { hostname : window.location.hostname
                 , port     : window.location.port
                 , protocol : (window.location.protocol.indexOf('https:') === 0) ? 'wss:' : 'ws:'
                 , search   : '%%UUID%%'
                 };

  notice('start');
  go(steward, 1);
};
</script>
</head>

<body onload="main();">
<div id='status' />
</body>
</html>
