<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>client bootstrap</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<style>
  body {
    font-family:monospace;
    background: #16161d;
    color: white;
  }
</style>
<script>

var reqno = 1;
var callbacks = {};

var add_callback = function(cb) {
  callbacks[reqno.toString()] = cb;

  return reqno++;
};

var create_user = function(ws, name, comments, role, cb) {
  var x = name.indexOf('/');

  ws.send(JSON.stringify({ path       : '/api/v1/user/create/' + name
                         , requestID  : add_callback(cb)
                         , name       : (x !== -1) ? name.slice(x + 1) : name
                         , comments   : comments
                         , role       : role
                         , clientName : 'bootstrap'
                         }));
};

var authenticate_user = function(ws, name, code, cb) {
  ws.send(JSON.stringify({ path      : '/api/v1/user/authenticate/' + name
                         , requestID : add_callback(cb)
                         , response  : code
                         }));
};

var list_users = function(ws, cb) {
  ws.send(JSON.stringify({ path      : '/api/v1/user/list/'
                         , requestID : add_callback(cb)
                         , options   : { depth: 'all' }
                         }));
};


var ws = null;

var validate_create = function() {
  var create   = document.forms.createForm
    , name     = create.userName.value
    , comments = create.userComments.value
    , qrcode   = document.images.qrcode
    , otpURL   = document.getElementById('otpURL')
    , status   = document.getElementById('status')
    , test     = document.forms.testForm
    ;

  qrcode.src = 'qrcode.png';
  otpURL.href = '';
  status.innerHTML = '';

  if (!!name) name = name.replace(/^\s+|\s+$/g, '');
  if ((!name)
        || (name.length       ===  0)
        || (name.search(/\s/) !== -1)
        || (name.indexOf('-') ===  0)
        || (name.indexOf('.') !== -1)
        || (name.indexOf(':') !== -1)) {
    alert('invalid short name');
    return false;
  }

  if (!!comments) comments = comments.replace(/^\s+|\s+$/g, '');

  create_user(ws, name, comments, 'master', function(message) {
    var x;

    if (!!message.result) {
      qrcode.src = message.result.authenticatorURL;
      otpURL.href = message.result.otpURL;
      status.innerHTML = '<strong><font color="green">success.</strong></font>';
      x = name.indexOf('/');
      if (x !== -1) name = name.slice(0, x);
      test.userName.value = name + '/' + message.result.client;
      return true;
    }

    if (!!message.error) {
      status.innerHTML = '<strong><font color="red">' + message.error.diagnostic + '</strong></font>';
      return true;
    }

    return false;
  });

  return false;
};

var validate_test = function() {
  var test     = document.forms.testForm
    , name     = test.userName.value
    , code     = test.userCode.value
    , status2  = document.getElementById('status2')
    ;

  status2.innerHTML = '';

  if (!!code) code = code.replace(/^\s+|\s+$/g, '');
  if ((!code) || (code.length === 0)) {
    alert('invalid login code');
    return false;
  }

  authenticate_user(ws, name, code, function(message) {
    if (!!message.result) {
      status2.innerHTML = '<strong><font color="green">authorized as ' + message.result.role  + '.</strong></font>';
      return true;
    }

    if (!!message.error) {
      status2.innerHTML = '<strong><font color="red">' + message.error.diagnostic + '</strong></font>';
      return true;
    }

    return false;
  });

  return false;
};

var events = {};

var go = function(steward, i) {
  ws = new WebSocket(steward.protocol + '//' + steward.hostname + ':' + steward.port + '/manage' + steward.search);

  ws.onopen = function(event) {

    ws.send(JSON.stringify({ path        : '/api/v1/user/prime/1/1'
                           , fingerprint : '54:cc:01:fa:af:20:c4:76:80:a7:d0:79:29:2f:13:6a'
                           , requestID   : add_callback(function(message) { console.log(message); })
                           }));

    list_users(ws, function(message) { console.log(message); });
    return;

/*
    ws.send(JSON.stringify({ path         : '/api/v1/thing/pair/testing123'
                           , name         : 'testing456'
                           , requestID    : add_callback(function(message) { console.log(message); })
                           }));
    ws.send(JSON.stringify({ path         : '/api/v1/thing/hello/4'
                           , response     : '441587'
                           , requestID    : add_callback(function(message) { 
      console.log(message);
 */

      ws.send(JSON.stringify({ path       : '/api/v1/thing/prototype'
                             , things     :
                               { '/device/presence/mobile/iOS' :
                                 { name                        : true
                                 , status                      : [ 'present', 'absent', 'recent' ]
                                 }
                               }
                             , requestID  : add_callback(function(message) {
        console.log(message);

        ws.send(JSON.stringify({ path     : '/api/v1/thing/register'
                               , things   :
                                 { 'thingID1'   :
                                   { devicetype : '/device/presence/mobile/iOS'
                                   , name       : 'MTR\'s iPhone5'
                                   , status     : 'present'
                                   , device     :
                                     { name     : 'iPhone5'
                                     , maker    : 'Apple Inc.'
                                     , model    :
                                       { name   : 'iPhone5'
                                       , number : 'MD665LL/A'
                                       }
                                     , unit     : 
                                       { serial : 'F23C91AEC05E'
                                       , udn    : '195a42b0-ef6b-11e2-99d0-f23c91aec05e'
                                       }
                                     }
                                   , updated    : new Date().getTime()
                                   }
                                 }
                               , requestID  : add_callback(function(message) {
            var thingID;

            console.log(message);
            if (!message.things.thingID1) return console.log('no response for thingID1');
            if (!message.things.thingID1.success) return console.log('not successful for thingID1');
            if (!message.things.thingID1.thingID) return console.log('no thingID for thingID1');
            thingID = message.things.thingID1.thingID;

            setInterval(function() {
              var eventID
                , report = { path      : '/api/v1/thing/report'
                           , events    : {}
                           , requestID : add_callback(function(message) { console.log(message); })
                           }
                , update = { path      : '/api/v1/thing/update'
                           , things    : {}
                           , requestID : add_callback(function(message) { console.log(message); })
                           };

              for (eventID in events) if (events.hasOwnProperty(eventID)) report.events[eventID] = { reason : 'observe' };
              ws.send(JSON.stringify(report));

              update.things[thingID] = { name    : reqno.toString()
                                       , status  : 'present'
                                       , updated : new Date().getTime()
                                       };
              ws.send(JSON.stringify(update));
            }, 30 * 1000);
          })
        }));
      })
                             }));
/*
      })}));
 */
  };

  ws.onmessage = function(event) {
    var eventID, id, message;

    try {
      message = JSON.parse(event.data);
      id = message.requestID.toString();
      if ((!!message.events) || (!!message.tasks)) {
        switch(message.path) {
          case '/api/v1/thing/observe':
            for (eventID in message.events) {
              if (!message.events.hasOwnProperty(eventID)) continue;
              if (message.events[eventID].testOnly) console.log('testOnly');
              else events[eventID] = { observe: message.events[eventID].observe, parameter: message.events[eventID].parameter };
              message.events[eventID].status = 'success';
            }
            message.path = '/api/v1/thing/report';
            ws.send(JSON.stringify(message));
            break;

          default:
            console.log('unsolicited');
            console.log(message);
            break;
        }
      } else if ((!!callbacks[id]) && ((callbacks[id])(message))) delete(callbacks[id]);
    } catch(ex) {
      console.log(ex.message);
    }
  };

  ws.onclose = function(event) {
    console.log('onclose'); console.log(event);

    setTimeout (function() { go(steward, i + 1); }, 2500);
  };

  ws.onerror = function(event) {
    console.log('onerror'); console.log(event);

    try { ws.close (); } catch (ex) {}; ws = null;
    setTimeout (function() { go(steward, i + 1); }, 5000);
  };
};

var main = function() {
  var steward = { hostname : window.location.hostname
                 , port     : window.location.port
                 , protocol : (window.location.protocol.indexOf('https:') === 0) ? 'wss:' : 'ws:'
                 , search   : '%%UUID%%'
                 };

  go(steward, 1);
};
</script>
</head>

<body onload='main();'>
<div id='main'>
<center><strong><font size='+3'>NOTE: THE TEXT ON THIS PAGE IS ACCURATE, BUT NOT USER-FACING.</font></strong></center>

<h1>tl;dr</h1>
<ul>
<li>Be on your home network.

<li>You need a smartphone running  <a href='https://support.google.com/accounts/answer/1066447'>Google Authenticator</a>
or some other program that implements <a href='http://tools.ietf.org/html/rfc6238'>time-based one-time passwords (TOTP)</a>.
There are several out there for all major platforms and desktops.</li>

<li>Scroll to the bottom of this page, fill-in the form, and press "Submit".</li>

<li>Launch the authenticator and scan the QR code.</li>
</ul>

<h1>Creating an Account</h1>
<p>
Here is a form that asks you to input a short name (e.g., "root")
and a longer, more descriptive name (e.g., "Angus MacPhail").
When you enter that information and click "Submit",
a "QR code" will appear that you scan with the authenticator:
<ul>
<li>Launch the authenticator application on your smartphone.</li>

<li>Press the "+" button and then the "Scan Barcode" button.</li>

<li>Point the smartphone's camera at the browser's screen,
center the QR code in the viewfinder,
and the application will automatically focus on the QR code and do the rest.</li>
</ul>
</p>

<form name='createForm' onsubmit='return validate_create();' action='#'>
<table>
<tr><td>Short Name:</td>
    <td><input type='text' name='userName' /></td>
    <td width='120'>&nbsp;</td>
    <td rowspan='3'><a id='otpURL' href=''><img name='qrcode' src='qrcode.png' width='166' height='166' /></a></span></td>
</tr>
<tr><td>Descriptive Name:</td>
    <td><input type='text' name='userComments' /></td>
</tr>
<tr valign='top'>
    <td></td>
    <td><input type='submit' value='Create' /><br/><br/><span id='status'></span></td>
</tr>
</table>
</form>

<h1>Authenticating a Client</h1>
<p>
Here is a form that asks you to enter the six-digit code from Google
Authenticator and verify that everything's working.
</p>

<p>After you created an account,
did you notice the solidus ('/') and number appended to the short name below?
That identifies the client that is now associated with the user.
Clients authenticate to the steward, and the user associated with a client is authorized to invoke various API calls.
</p>

<form name='testForm' onsubmit='return validate_test();' action='#'>
<table>
<tr><td>Short Name:</td>
    <td><input type='text' name='userName' /></td>
</tr>
<tr><td>Login Code:</td>
    <td><input type='text' name='userCode' /></td>
</tr>
<tr valign='top'>
    <td></td>
    <td><input type='submit' value='Test' /><br/><br/><span id='status2'></span></td>
</tr>
</table>
</form>

</div>
</body>
</html>
